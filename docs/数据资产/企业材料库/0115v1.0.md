# 企业材料库页面规范 (Enterprise Material Library)

**Page Name:** 企业材料库  
**Module:** 数据资产 (DataAsset)  
**Route:** `/asset/material/list`  
**Version:** v1.0  
**Date:** 2026-01-15  
**Owner:** [YourName]  
**Status:** Draft

**Depends On:**
- specs/global/01_LayoutSpec.md v1.0
- specs/global/02_ComponentSpec.md v1.0
- specs/global/03_DataFlowSpec.md v1.0
- specs/domain/15_DomainEntitySpec.md v1.0
- specs/domain/16_FieldDictionary.md v1.0
- specs/modules/M02_DataAsset.md v1.0
- ui/04_WebixWrapperContracts.md v1.0

---

## 1. 页面定位

### 1.1 Purpose
企业材料库是数据资产模块的核心查询页面，用于查看和导出企业自有的材料价格数据。

### 1.2 用户场景
- 造价员查询某地区某时期的材料综合价格
- 根据材料属性（牌号/直径/品牌）筛选定位材料
- 查看材料价格的历史趋势和样本溯源
- 批量导出材料价格数据

### 1.3 Scope

**In Scope:**
- 查看材料价格列表
- 按分类/属性/关键词筛选
- 查看单条材料详情（抽屉）
- 单选/多选导出

**Out of Scope:**
- 新增/编辑/删除材料（在"企业数据治理"模块）
- 材料分类管理
- 价格审核流程

---

## 2. 用户与权限

### 2.1 可访问角色

| 角色 | 访问 | 查看列表 | 查看详情 | 导出 |
|------|:----:|:-------:|:-------:|:----:|
| 企业全员 | ✓ | ✓ | ✓ | ✓ |
| 数据管理员 | ✓ | ✓ | ✓ | ✓ |
| 访客 | ✗ | - | - | - |

### 2.2 权限说明
- 本页面为**只读查询页面**，无编辑权限控制
- 导出功能对所有企业员工开放
- 编辑/删除操作在"企业数据治理"模块，不在本页面

---

## 3. 布局设计

### 3.1 Layout Type
**Workbench Split（工作台三栏布局）**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          顶部全局筛选栏                                   │
│  [地区] [时间] [阶段] [来源] [搜索框]              [导出] [设置]          │
├──────────────┬──────────────────────────────────────────────────────────┤
│              │                                                          │
│   左侧       │                    中间列表区                             │
│   分类树     │  ┌─────────────────────────────────────────────────────┐ │
│              │  │ L3 属性筛选：[牌号] [直径] [品牌] [产地]             │ │
│   全部材料   │  ├─────────────────────────────────────────────────────┤ │
│   ├ 土建材料 │  │ □ 材料信息        单位  基准价  综合价  偏离  走势  │ │
│   │ ├ 钢材   │  │ □ 热轧带肋钢筋    t    4100   4250   +3.66% ～～   │ │
│   │ │ ├ 钢筋 │  │ □ 热轧带肋钢筋    t    4100   4180   +1.95% ～～   │ │
│   │ └ ...    │  │ ...                                                 │ │
│   ├ 安装材料 │  ├─────────────────────────────────────────────────────┤ │
│   └ 装饰材料 │  │ 共 X 条数据                    [上一页] [1] [下一页] │ │
│              │  └─────────────────────────────────────────────────────┘ │
│   ──────────│                                                          │
│   材料总数   │                                                          │
│   本月更新   │                                                          │
└──────────────┴──────────────────────────────────────────────────────────┘

                                    ↓ 点击某行
                    ┌───────────────────────────────────┐
                    │         右侧抽屉（Drawer）         │
                    │                                   │
                    │  材料详情 + 历史趋势 + 样本溯源    │
                    │                                   │
                    └───────────────────────────────────┘
```

### 3.2 Panel 配置

| Panel | 位置 | 宽度 | 最小宽度 | 滚动 | 可调整 |
|-------|------|------|---------|------|--------|
| 左侧分类树 | left | 220px | 180px | panel-scroll | ✗ |
| 中间列表区 | center | 自适应 | 600px | panel-scroll | - |
| 右侧抽屉 | right-drawer | 400px | 360px | panel-scroll | ✗ |

### 3.3 Exceptions
- 无

---

## 4. UI 组件清单

### 4.1 组件来源（遵循 ComponentPriority）

| 组件 | 来源 | 用途 |
|------|------|------|
| Tree | Webix Tree | 左侧分类树（懒加载） |
| DataTable | Webix DataTable | 中间材料列表（大数据量） |
| Select | Ant Design | 顶部筛选下拉 |
| Input.Search | Ant Design | 搜索框 |
| Tag | Ant Design | L3 属性筛选标签 |
| Drawer | Ant Design | 右侧详情抽屉 |
| Button | Ant Design | 导出等操作按钮 |
| Descriptions | Ant Design | 抽屉内材料属性 |
| Statistic | Ant Design | 价格展示 |
| Line Chart | 自定义/ECharts | 走势图（迷你图 + 详情图） |
| Pagination | Ant Design | 分页器 |

### 4.2 State Triad（三态）

| 区域 | Loading | Empty | Error |
|------|---------|-------|-------|
| 左侧树 | 骨架树 | "暂无分类" | 错误提示 + 重试 |
| 中间列表 | 骨架表格 | "暂无材料数据" + 提示检查筛选条件 | 错误提示 + 重试 |
| 右侧抽屉 | Spin | - | 错误提示 + 重试 |

---

## 5. 交互设计

### 5.1 顶部全局筛选栏

| 控件 | 类型 | 默认值 | 触发方式 | 说明 |
|------|------|--------|---------|------|
| 地区 | Select | 用户所在城市 | 选择后立即刷新 | 省市级联 |
| 时间 | DatePicker (月) | 当前月 | 选择后立即刷新 | 格式 YYYY-MM |
| 阶段 | Select | 全部 | 选择后立即刷新 | 控制价/招标价/市场价 |
| 来源 | Select | 全部 | 选择后立即刷新 | 信息价/市场采集/企业自定义 |
| 搜索框 | Input.Search | - | **回车或点击搜索** | 搜索材料名称/编码/品牌 |
| 导出 | Button | - | 点击 | 导出当前筛选结果或勾选项 |
| 设置 | Button | - | 点击 | 列显示设置（可选） |

### 5.2 左侧分类树

| 交互 | 行为 |
|------|------|
| 点击分类节点 | **立即刷新**中间列表，显示该分类下材料 |
| 展开/收起节点 | **懒加载**子节点（首次展开时请求） |
| 节点数字角标 | 显示该分类下材料数量 |
| 底部统计 | 显示：材料总数 / 本月更新数 |

### 5.3 L3 属性筛选

| 交互 | 行为 |
|------|------|
| 筛选条件来源 | 根据选中的 L3 分类**动态加载**（后台配置） |
| 选择方式 | **单选**（Tag 形式，点击选中/取消） |
| 触发方式 | **立即刷新**列表 |
| 无筛选条件时 | 隐藏 L3 筛选区域 |

**示例：钢筋分类的 L3 属性**
- 牌号：HRB400 / HRB500 / HPB300
- 直径：Φ6 / Φ8 / Φ10 / Φ12 / Φ14 / Φ16 / Φ18 / Φ20 / Φ22 / Φ25 / Φ28 / Φ32
- 品牌：武钢 / 鄂钢 / 马钢 / 沙钢 / 首钢
- 产地：本地 / 外地

### 5.4 中间列表（DataTable）

#### 列定义

| 列 | 字段 | 宽度 | 排序 | 说明 |
|----|------|------|:----:|------|
| 勾选框 | - | 40px | ✗ | 多选，用于批量导出 |
| 材料信息 | materialName + spec + brand | 自适应 | ✗ | 主列，含名称/规格/品牌 |
| 单位 | unit | 60px | ✗ | |
| 基准价 | basePrice | 100px | ✓ | 信息价/政府指导价 |
| 综合价 | compositePrice | 100px | ✓ | 加权综合入库价，**主要字段加粗** |
| 偏离 | deviationRate | 80px | ✓ | 百分比，正数红色/负数绿色 |
| 走势 | trendData | 120px | ✗ | 迷你折线图（近 12 期） |
| 样本 | sampleCount | 60px | ✓ | 样本数量 |

#### 交互行为

| 交互 | 行为 |
|------|------|
| 单击行 | 打开右侧**抽屉**，显示该材料详情 |
| 勾选行 | 加入批量导出选择集 |
| 全选 | 选中当前页所有行 |
| 排序 | 点击列头排序（升序/降序切换） |
| 分页 | 每页 20-50 条（默认 50），点击切换页码 |

### 5.5 右侧抽屉（Drawer）

#### 触发方式
- **点击列表某一行**打开抽屉
- 点击抽屉外部或关闭按钮关闭

#### 抽屉内容结构

```
┌─────────────────────────────────────────┐
│ 热轧带肋钢筋                    [关闭]  │
│ MAT-2024-00156                          │
│ ○ 已审核  武汉市  2025-12  控制价       │
├─────────────────────────────────────────┤
│ ▼ 材料属性                              │
│   牌号：HRB400    直径：Φ12             │
│   品牌：武钢      产地：本地             │
├─────────────────────────────────────────┤
│   基准价          综合入库价             │
│   4,100.00        4,250.00              │
│   集团指导价      加权计算               │
│                                         │
│   偏离度：+3.66%  离散系数：8.5% 一般    │
│   价格区间：3,980.00 - 4,450.00         │
│   样本量：156 个                         │
├─────────────────────────────────────────┤
│ ▼ 历史趋势（近12期）                    │
│   [────────折线图────────]              │
├─────────────────────────────────────────┤
│ ▼ 样本溯源（加权计算来源）              │
│   ┌─────────────────────────────────┐   │
│   │ 来源名称    类型   单价   权重  │   │
│   │ 武汉市信息价 信息价 4200  40%  │   │
│   │ 供应商A报价  市场价 4280  30%  │   │
│   │ ...                             │   │
│   └─────────────────────────────────┘   │
│                                         │
│   [查看更多历史]                        │
└─────────────────────────────────────────┘
```

#### 抽屉字段明细

| 区域 | 字段 | 说明 |
|------|------|------|
| 头部 | materialName | 材料名称 |
| | materialCode | 材料编码 |
| | status + region + period + priceStage | 状态标签 |
| 材料属性 | spec, brand, origin 等 | 根据 L3 动态展示 |
| 价格对比 | basePrice | 基准价（信息价/集团指导价） |
| | compositePrice | 综合入库价（加权计算） |
| | deviationRate | 偏离度（百分比） |
| | cvRate | 离散系数（CV） |
| | priceRange | 价格区间（最低-最高） |
| | sampleCount | 样本数量 |
| 历史趋势 | trendChartData | 近 12 期折线图 |
| 样本溯源 | sampleList[] | 来源名称/类型/单价/权重/日期 |

### 5.6 导出功能

| 场景 | 行为 |
|------|------|
| 未勾选任何行 | 导出当前筛选条件下的**全部数据** |
| 勾选了部分行 | 导出**勾选的行** |
| 导出格式 | Excel (.xlsx) |
| 导出字段 | 材料编码/名称/规格/单位/基准价/综合价/偏离/样本数 |

---

## 6. 数据流设计

### 6.1 Queries（读请求）

| Query Key | 触发时机 | 请求参数 | 缓存 | 说明 |
|-----------|---------|---------|------|------|
| `asset_material_categoryTree` | 页面加载 | parentId (懒加载) | 5min | 分类树 |
| `asset_material_list` | 筛选变化/分页 | 见下方 | 30s | 材料列表 |
| `asset_material_l3Attributes` | 选中 L3 分类 | categoryId | 5min | L3 属性筛选项 |
| `asset_material_detail` | 点击行 | materialId | 1min | 材料详情（抽屉） |
| `asset_material_trendHistory` | 抽屉打开 | materialId, periods | 1min | 历史趋势 |
| `asset_material_sampleList` | 抽屉打开 | materialId | 1min | 样本溯源 |

#### 列表请求参数

```typescript
interface MaterialListParams {
  // 全局筛选
  regionCode: string;        // 地区编码
  period: string;            // 时间 YYYY-MM
  priceStage?: string;       // 阶段
  sourceType?: string;       // 来源
  keyword?: string;          // 搜索关键词
  
  // 分类筛选
  categoryId: string;        // 分类 ID
  
  // L3 属性筛选（动态）
  attributes?: Record<string, string>;  // { brandCode: 'wugang', diameter: '12' }
  
  // 分页
  page: number;
  pageSize: number;          // 20-50
  
  // 排序
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}
```

### 6.2 Mutations（写请求）

| Mutation | 触发 | 说明 |
|----------|------|------|
| `asset_material_export` | 点击导出 | 异步导出，返回下载链接 |

### 6.3 Empty Rules

| 场景 | 空状态文案 | CTA |
|------|-----------|-----|
| 列表无数据 | "未找到符合条件的材料" | "清除筛选条件" 按钮 |
| 分类树无数据 | "暂无材料分类" | - |
| 样本溯源无数据 | "暂无样本数据" | - |

---

## 7. 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 列表请求失败 | 表格区域显示错误提示 + 重试按钮 |
| 分类树请求失败 | 树区域显示错误提示 + 重试按钮 |
| 详情请求失败 | 抽屉内显示错误提示 + 重试按钮 |
| 导出失败 | Toast 提示"导出失败，请重试" |
| 网络超时 | Toast 提示"网络超时，请检查网络" |

---

## 8. 性能设计

### 8.1 数据规模

| 维度 | 预期规模 | 策略 |
|------|---------|------|
| 原始数据 | 5000万+ | 后端聚合去重 |
| 去重后材料 | ~100万 | 分页 + 索引优化 |
| 单页数据 | 50 条 | 默认分页大小 |
| 分类树节点 | 数千 | 懒加载 |

### 8.2 性能策略

| 策略 | 实现 |
|------|------|
| 分页 | 必须，默认 50 条/页 |
| 懒加载 | 分类树按需加载子节点 |
| 防抖 | 搜索框回车触发，非实时 |
| 缓存 | 分类树 5min，列表 30s |
| 虚拟滚动 | 如需支持更大单页，启用 Webix 虚拟滚动 |

### 8.3 MUST Rules

- MUST: 列表必须分页，禁止一次加载全部
- MUST: 分类树必须懒加载
- MUST: 搜索必须回车/点击触发，禁止实时搜索
- MUST: 导出走异步任务，禁止同步阻塞

---

## 9. 无障碍 & 国际化

### 9.1 Accessibility

| 要求 | 实现 |
|------|------|
| 键盘导航 | 表格支持 ↑↓ 切换行，Enter 打开详情 |
| 焦点管理 | 抽屉打开后焦点移入，关闭后返回触发行 |
| 屏幕阅读器 | 表格行有 aria-label |

### 9.2 i18n

| 内容 | Key 前缀 |
|------|---------|
| 页面标题 | `asset.material.title` |
| 筛选标签 | `asset.material.filter.*` |
| 表格列头 | `asset.material.column.*` |
| 空状态文案 | `asset.material.empty.*` |
| 按钮文字 | `asset.material.action.*` |

---

## 10. 日志埋点

| EventName | 触发时机 | Level | Fields |
|-----------|---------|-------|--------|
| `material_page_enter` | 进入页面 | info | route, userId, region |
| `material_filter_change` | 筛选条件变化 | info | filterType, filterValue |
| `material_search` | 搜索 | info | keyword, resultCount |
| `material_detail_view` | 查看详情 | info | materialId, materialCode |
| `material_export` | 导出 | info | exportCount, exportType |
| `material_api_error` | 请求失败 | error | api, errorCode, errorMsg |

---

## 11. Acceptance Criteria (DoD)

### 11.1 功能验收

- [ ] 顶部筛选（地区/时间/阶段/来源）正常工作
- [ ] 搜索框回车/点击触发搜索
- [ ] 左侧分类树点击立即刷新列表
- [ ] 左侧分类树懒加载子节点
- [ ] L3 属性筛选根据分类动态加载
- [ ] L3 筛选单选，立即刷新
- [ ] 表格支持多选（勾选框）
- [ ] 表格支持排序
- [ ] 表格分页正常
- [ ] 点击行打开右侧抽屉
- [ ] 抽屉显示材料详情/趋势图/样本溯源
- [ ] 导出功能正常（勾选导出/全量导出）

### 11.2 三态验收

- [ ] 列表 Loading 状态：骨架表格
- [ ] 列表 Empty 状态：空状态插图 + 提示
- [ ] 列表 Error 状态：错误提示 + 重试
- [ ] 分类树 Loading 状态
- [ ] 抽屉 Loading 状态

### 11.3 性能验收

- [ ] 100 万数据量下列表响应 < 2s
- [ ] 分类树展开响应 < 1s
- [ ] 分页切换响应 < 1s

### 11.4 一致性验收

- [ ] 组件来源符合 ComponentPriority（Webix 表格/Ant Design 表单）
- [ ] 字段命名符合 FieldDictionary
- [ ] 布局符合 LayoutSpec

---

## 12. Changelog

- v1.0 (2026-01-15): 初始版本
  - **What:** 创建企业材料库页面规范
  - **Why:** 数据资产模块核心查询页面
  - **Impact:** 新增页面，无影响