# 企业清单库页面规范 (Enterprise BOQ Library)

**Page Name:** 企业清单库  
**Module:** 数据资产 (DataAsset)  
**Route:** `/asset/billitem/list`  
**Version:** v1.0  
**Date:** 2026-01-15  
**Owner:** [YourName]  
**Status:** Draft

**Depends On:**
- specs/global/01_LayoutSpec.md v1.0
- specs/global/02_ComponentSpec.md v1.0
- specs/global/03_DataFlowSpec.md v1.0
- specs/domain/15_DomainEntitySpec.md v1.0
- specs/domain/16_FieldDictionary.md v1.0
- specs/modules/M02_DataAsset.md v1.0
- ui/04_WebixWrapperContracts.md v1.0

---

## 1. 页面定位

### 1.1 Purpose
企业清单库是数据资产模块的核心查询页面，用于查看和导出企业自有的清单综合单价数据。

### 1.2 用户场景
- 造价员查询某地区某时期的清单综合单价
- 根据项目特征（土壤类别/挖深/施工方式）筛选定位清单项
- 查看清单价格的历史趋势和样本溯源
- 批量导出清单价格数据

### 1.3 Scope

**In Scope:**
- 查看清单价格列表
- 按分类/项目特征/关键词筛选
- 查看单条清单详情（抽屉）
- 单选/多选导出

**Out of Scope:**
- 新增/编辑/删除清单（在"企业数据治理"模块）
- 清单分类管理
- 价格审核流程

---

## 2. 用户与权限

### 2.1 可访问角色

| 角色 | 访问 | 查看列表 | 查看详情 | 导出 |
|------|:----:|:-------:|:-------:|:----:|
| 企业全员 | ✓ | ✓ | ✓ | ✓ |
| 数据管理员 | ✓ | ✓ | ✓ | ✓ |
| 访客 | ✗ | - | - | - |

### 2.2 权限说明
- 本页面为**只读查询页面**，无编辑权限控制
- 导出功能对所有企业员工开放
- 编辑/删除操作在"企业数据治理"模块，不在本页面

---

## 3. 布局设计

### 3.1 Layout Type
**Workbench Split（工作台三栏布局）**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          顶部全局筛选栏                                   │
│  [地区] [时间] [阶段] [来源] [搜索框]              [导出] [设置]          │
├──────────────┬──────────────────────────────────────────────────────────┤
│              │                                                          │
│   左侧       │                    中间列表区                             │
│   分类树     │  ┌─────────────────────────────────────────────────────┐ │
│              │  │ L3 项目特征筛选：[土壤类别] [挖深] [地下水] [运距]   │ │
│   全部清单   │  ├─────────────────────────────────────────────────────┤ │
│   ├ 建筑工程 │  │ □ 清单信息        单位  基准价  综合价  偏离  走势  │ │
│   │ ├ 土石方 │  │ □ 挖基坑土方 ○    m³   32.50  35.80  +10.15% ～～  │ │
│   │ │ ├ 挖土方│  │ □ 挖基坑土方 ○    m³   38.00  42.50  +11.84% ～～  │ │
│   │ └ ...    │  │ ...                                                 │ │
│   ├ 装饰工程 │  ├─────────────────────────────────────────────────────┤ │
│   └ 安装工程 │  │ 共 X 条数据                    [上一页] [1] [下一页] │ │
│              │  └─────────────────────────────────────────────────────┘ │
│   ──────────│                                                          │
│   清单总数   │                                                          │
│   本月更新   │                                                          │
└──────────────┴──────────────────────────────────────────────────────────┘

                                    ↓ 点击某行
                    ┌───────────────────────────────────┐
                    │         右侧抽屉（Drawer）         │
                    │                                   │
                    │  清单详情 + 历史趋势 + 样本溯源    │
                    │                                   │
                    └───────────────────────────────────┘
```

### 3.2 Panel 配置

| Panel | 位置 | 宽度 | 最小宽度 | 滚动 | 可调整 |
|-------|------|------|---------|------|--------|
| 左侧分类树 | left | 220px | 180px | panel-scroll | ✗ |
| 中间列表区 | center | 自适应 | 600px | panel-scroll | - |
| 右侧抽屉 | right-drawer | 400px | 360px | panel-scroll | ✗ |

### 3.3 Exceptions
- 无

---

## 4. UI 组件清单

### 4.1 组件来源（遵循 ComponentPriority）

| 组件 | 来源 | 用途 |
|------|------|------|
| Tree | Webix Tree | 左侧分类树（懒加载） |
| DataTable | Webix DataTable | 中间清单列表（大数据量） |
| Select | Ant Design | 顶部筛选下拉 |
| Input.Search | Ant Design | 搜索框 |
| Tag | Ant Design | L3 项目特征筛选标签 |
| Drawer | Ant Design | 右侧详情抽屉 |
| Button | Ant Design | 导出等操作按钮 |
| Descriptions | Ant Design | 抽屉内清单属性 |
| Statistic | Ant Design | 价格展示 |
| Line Chart | 自定义/ECharts | 走势图（迷你图 + 详情图） |
| Pagination | Ant Design | 分页器 |

### 4.2 State Triad（三态）

| 区域 | Loading | Empty | Error |
|------|---------|-------|-------|
| 左侧树 | 骨架树 | "暂无分类" | 错误提示 + 重试 |
| 中间列表 | 骨架表格 | "暂无清单数据" + 提示检查筛选条件 | 错误提示 + 重试 |
| 右侧抽屉 | Spin | - | 错误提示 + 重试 |

---

## 5. 交互设计

### 5.1 顶部全局筛选栏

| 控件 | 类型 | 默认值 | 触发方式 | 说明 |
|------|------|--------|---------|------|
| 地区 | Select | 用户所在城市 | 选择后立即刷新 | 省市级联 |
| 时间 | DatePicker (月) | 当前月 | 选择后立即刷新 | 格式 YYYY-MM |
| 阶段 | Select | 全部 | 选择后立即刷新 | 控制价/招标价/市场价 |
| 来源 | Select | 全部 | 选择后立即刷新 | 信息价/市场采集/企业自定义 |
| 搜索框 | Input.Search | - | **回车或点击搜索** | 搜索清单编码/名称/特征 |
| 导出 | Button | - | 点击 | 导出当前筛选结果或勾选项 |
| 设置 | Button | - | 点击 | 列显示设置（可选） |

### 5.2 左侧分类树

| 交互 | 行为 |
|------|------|
| 点击分类节点 | **立即刷新**中间列表，显示该分类下清单 |
| 展开/收起节点 | **懒加载**子节点（首次展开时请求） |
| 节点数字角标 | 显示该分类下清单数量 |
| 底部统计 | 显示：清单总数 / 本月更新数 |

**分类树结构示例：**
```
全部清单 (9)
├── 建筑工程 (856)
│   ├── 土石方工程 (125)
│   │   ├── 挖土方 (68)
│   │   ├── 回填土方 (32)
│   │   └── 土方运输 (25)
│   ├── 砌筑工程 (98)
│   ├── 混凝土工程 (245)
│   └── 钢筋工程 (156)
├── 装饰工程 (423)
└── 安装工程 (244)
```

### 5.3 L3 项目特征筛选

| 交互 | 行为 |
|------|------|
| 筛选条件来源 | 根据选中的 L3 分类**动态加载**（后台配置） |
| 选择方式 | **单选**（Tag 形式，点击选中/取消） |
| 触发方式 | **立即刷新**列表 |
| 无筛选条件时 | 隐藏 L3 筛选区域 |

**示例：挖土方分类的 L3 项目特征**

| 特征名称 | 可选值 |
|---------|-------|
| 土壤类别 | 一类土 / 二类土 / 三类土 / 四类土 / 岩石 |
| 挖深 | 2m以内 / 2-4m / 4-6m / 6m以上 |
| 地下水 | 无 / 有(需降水) |
| 弃土运距 | 1km以内 / 1-5km / 5-10km / 10km以上 |
| 施工方式 | 人工 / 机械 / 人机配合 |

### 5.4 中间列表（DataTable）

#### 列定义

| 列 | 字段 | 宽度 | 排序 | 说明 |
|----|------|------|:----:|------|
| 勾选框 | - | 40px | ✗ | 多选，用于批量导出 |
| 清单信息 | billItemName + billItemCode + features | 自适应 | ✗ | 主列，含名称/编码/特征描述 |
| 单位 | unit | 60px | ✗ | |
| 基准价 | basePrice | 100px | ✓ | 信息价/政府指导价 |
| 综合价 | compositePrice | 100px | ✓ | 加权综合单价，**主要字段加粗** |
| 偏离 | deviationRate | 80px | ✓ | 百分比，正数红色/负数绿色 |
| 走势 | trendData | 120px | ✗ | 迷你折线图（近 12 期） |
| 样本 | sampleCount | 60px | ✓ | 样本数量 |

#### 清单信息列展示格式
```
挖基坑土方 ○
010102001
三类土/深3m/无地下水/运1km
```
- 第一行：清单名称 + 状态图标
- 第二行：清单编码（灰色）
- 第三行：项目特征摘要（蓝色链接样式）

#### 交互行为

| 交互 | 行为 |
|------|------|
| 单击行 | 打开右侧**抽屉**，显示该清单详情 |
| 勾选行 | 加入批量导出选择集 |
| 全选 | 选中当前页所有行 |
| 排序 | 点击列头排序（升序/降序切换） |
| 分页 | 每页 20-50 条（默认 50），点击切换页码 |

### 5.5 右侧抽屉（Drawer）

#### 触发方式
- **点击列表某一行**打开抽屉
- 点击抽屉外部或关闭按钮关闭

#### 抽屉内容结构

```
┌─────────────────────────────────────────┐
│ 挖基坑土方                      [关闭]  │
│ 010102001                               │
│ ○ 已审核  武汉市  2025-12  控制价       │
├─────────────────────────────────────────┤
│ ▼ 项目特征                              │
│   土壤类别：三类土    挖深：3m          │
│   地下水：无          弃土运距：1km     │
│   施工方式：机械                        │
├─────────────────────────────────────────┤
│   基准价          综合单价               │
│   32.50           35.80                 │
│   信息价          加权计算               │
│                                         │
│   偏离度：+10.15%  离散系数：12.5% 较高  │
│   价格区间：30.00 - 42.00               │
│   样本量：89 个                          │
├─────────────────────────────────────────┤
│ ▼ 历史趋势（近12期）                    │
│   [────────折线图────────]              │
├─────────────────────────────────────────┤
│ ▼ 样本溯源（加权计算来源）              │
│   ┌─────────────────────────────────┐   │
│   │ 来源名称    类型   单价   权重  │   │
│   │ 武汉市指标  指标价 33.50  50%  │   │
│   │ 项目A结算   结算价 36.20  30%  │   │
│   │ ...                             │   │
│   └─────────────────────────────────┘   │
│                                         │
│   [查看更多历史]                        │
└─────────────────────────────────────────┘
```

#### 抽屉字段明细

| 区域 | 字段 | 说明 |
|------|------|------|
| 头部 | billItemName | 清单名称 |
| | billItemCode | 清单编码（9位/12位） |
| | status + region + period + priceStage | 状态标签 |
| 项目特征 | features[] | 根据 L3 动态展示（土壤类别/挖深/地下水等） |
| 价格对比 | basePrice | 基准价（信息价/指标价） |
| | compositePrice | 综合单价（加权计算） |
| | deviationRate | 偏离度（百分比） |
| | cvRate | 离散系数（CV） |
| | priceRange | 价格区间（最低-最高） |
| | sampleCount | 样本数量 |
| 历史趋势 | trendChartData | 近 12 期折线图 |
| 样本溯源 | sampleList[] | 来源名称/类型/单价/权重/日期 |

### 5.6 导出功能

| 场景 | 行为 |
|------|------|
| 未勾选任何行 | 导出当前筛选条件下的**全部数据** |
| 勾选了部分行 | 导出**勾选的行** |
| 导出格式 | Excel (.xlsx) |
| 导出字段 | 清单编码/名称/项目特征/单位/基准价/综合价/偏离/样本数 |

---

## 6. 数据流设计

### 6.1 Queries（读请求）

| Query Key | 触发时机 | 请求参数 | 缓存 | 说明 |
|-----------|---------|---------|------|------|
| `asset_billitem_categoryTree` | 页面加载 | parentId (懒加载) | 5min | 分类树 |
| `asset_billitem_list` | 筛选变化/分页 | 见下方 | 30s | 清单列表 |
| `asset_billitem_l3Features` | 选中 L3 分类 | categoryId | 5min | L3 项目特征筛选项 |
| `asset_billitem_detail` | 点击行 | billItemId | 1min | 清单详情（抽屉） |
| `asset_billitem_trendHistory` | 抽屉打开 | billItemId, periods | 1min | 历史趋势 |
| `asset_billitem_sampleList` | 抽屉打开 | billItemId | 1min | 样本溯源 |

#### 列表请求参数

```typescript
interface BillItemListParams {
  // 全局筛选
  regionCode: string;        // 地区编码
  period: string;            // 时间 YYYY-MM
  priceStage?: string;       // 阶段
  sourceType?: string;       // 来源
  keyword?: string;          // 搜索关键词
  
  // 分类筛选
  categoryId: string;        // 分类 ID
  
  // L3 项目特征筛选（动态）
  features?: Record<string, string>;  // { soilType: 'class3', depth: '3m' }
  
  // 分页
  page: number;
  pageSize: number;          // 20-50
  
  // 排序
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}
```

### 6.2 Mutations（写请求）

| Mutation | 触发 | 说明 |
|----------|------|------|
| `asset_billitem_export` | 点击导出 | 异步导出，返回下载链接 |

### 6.3 Empty Rules

| 场景 | 空状态文案 | CTA |
|------|-----------|-----|
| 列表无数据 | "未找到符合条件的清单" | "清除筛选条件" 按钮 |
| 分类树无数据 | "暂无清单分类" | - |
| 样本溯源无数据 | "暂无样本数据" | - |

---

## 7. 错误处理

| 错误场景 | 处理方式 |
|---------|---------|
| 列表请求失败 | 表格区域显示错误提示 + 重试按钮 |
| 分类树请求失败 | 树区域显示错误提示 + 重试按钮 |
| 详情请求失败 | 抽屉内显示错误提示 + 重试按钮 |
| 导出失败 | Toast 提示"导出失败，请重试" |
| 网络超时 | Toast 提示"网络超时，请检查网络" |

---

## 8. 性能设计

### 8.1 数据规模

| 维度 | 预期规模 | 策略 |
|------|---------|------|
| 原始数据 | 5000万+ | 后端聚合去重 |
| 去重后清单 | ~100万 | 分页 + 索引优化 |
| 单页数据 | 50 条 | 默认分页大小 |
| 分类树节点 | 数千 | 懒加载 |

### 8.2 性能策略

| 策略 | 实现 |
|------|------|
| 分页 | 必须，默认 50 条/页 |
| 懒加载 | 分类树按需加载子节点 |
| 防抖 | 搜索框回车触发，非实时 |
| 缓存 | 分类树 5min，列表 30s |
| 虚拟滚动 | 如需支持更大单页，启用 Webix 虚拟滚动 |

### 8.3 MUST Rules

- MUST: 列表必须分页，禁止一次加载全部
- MUST: 分类树必须懒加载
- MUST: 搜索必须回车/点击触发，禁止实时搜索
- MUST: 导出走异步任务，禁止同步阻塞

---

## 9. 无障碍 & 国际化

### 9.1 Accessibility

| 要求 | 实现 |
|------|------|
| 键盘导航 | 表格支持 ↑↓ 切换行，Enter 打开详情 |
| 焦点管理 | 抽屉打开后焦点移入，关闭后返回触发行 |
| 屏幕阅读器 | 表格行有 aria-label |

### 9.2 i18n

| 内容 | Key 前缀 |
|------|---------|
| 页面标题 | `asset.billitem.title` |
| 筛选标签 | `asset.billitem.filter.*` |
| 表格列头 | `asset.billitem.column.*` |
| 空状态文案 | `asset.billitem.empty.*` |
| 按钮文字 | `asset.billitem.action.*` |

---

## 10. 日志埋点

| EventName | 触发时机 | Level | Fields |
|-----------|---------|-------|--------|
| `billitem_page_enter` | 进入页面 | info | route, userId, region |
| `billitem_filter_change` | 筛选条件变化 | info | filterType, filterValue |
| `billitem_search` | 搜索 | info | keyword, resultCount |
| `billitem_detail_view` | 查看详情 | info | billItemId, billItemCode |
| `billitem_export` | 导出 | info | exportCount, exportType |
| `billitem_api_error` | 请求失败 | error | api, errorCode, errorMsg |

---

## 11. Acceptance Criteria (DoD)

### 11.1 功能验收

- [ ] 顶部筛选（地区/时间/阶段/来源）正常工作
- [ ] 搜索框回车/点击触发搜索
- [ ] 左侧分类树点击立即刷新列表
- [ ] 左侧分类树懒加载子节点
- [ ] L3 项目特征筛选根据分类动态加载
- [ ] L3 筛选单选，立即刷新
- [ ] 表格支持多选（勾选框）
- [ ] 表格支持排序
- [ ] 表格分页正常
- [ ] 点击行打开右侧抽屉
- [ ] 抽屉显示清单详情/趋势图/样本溯源
- [ ] 导出功能正常（勾选导出/全量导出）

### 11.2 三态验收

- [ ] 列表 Loading 状态：骨架表格
- [ ] 列表 Empty 状态：空状态插图 + 提示
- [ ] 列表 Error 状态：错误提示 + 重试
- [ ] 分类树 Loading 状态
- [ ] 抽屉 Loading 状态

### 11.3 性能验收

- [ ] 100 万数据量下列表响应 < 2s
- [ ] 分类树展开响应 < 1s
- [ ] 分页切换响应 < 1s

### 11.4 一致性验收

- [ ] 组件来源符合 ComponentPriority（Webix 表格/Ant Design 表单）
- [ ] 字段命名符合 FieldDictionary
- [ ] 布局符合 LayoutSpec
- [ ] 与材料库页面交互模式一致

---

## 12. 与材料库的差异对照

| 维度 | 材料库 (P_MaterialList) | 清单库 (P_BillItemList) |
|------|------------------------|------------------------|
| 路由 | `/asset/material/list` | `/asset/billitem/list` |
| 实体 | Material | BillItem |
| L3 筛选名称 | 属性筛选 | 项目特征筛选 |
| L3 筛选示例 | 牌号/直径/品牌/产地 | 土壤类别/挖深/地下水/运距/施工方式 |
| 主列名称 | 材料信息 | 清单信息 |
| 主列第三行 | 规格/品牌（蓝色） | 项目特征摘要（蓝色） |
| 分类树根节点 | 全部材料 | 全部清单 |
| 分类示例 | 土建材料/钢材/钢筋 | 建筑工程/土石方/挖土方 |
| 底部统计 | 材料总数 | 清单总数 |

---

## 13. Changelog

- v1.0 (2026-01-15): 初始版本
  - **What:** 创建企业清单库页面规范
  - **Why:** 数据资产模块核心查询页面
  - **Impact:** 新增页面，无影响